{% extends 'base.html' %}
{% block title %}Audit Log - {{ config.name }}{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <h3>Audit Log for: {{ config.name }}</h3>
        <a href="{{ url_for('config.export_config_auditlog', config_id=config.id) }}" class="btn btn-success mb-3">Export CSV</a>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="auditlog-accordion">
                {% for loginfo in logs %}
                {% set log = loginfo.log %}
                <tr class="auditlog-row" data-diff-id="diff-{{ loop.index0 }}" style="cursor:pointer;">
                    <td style="width:24px;">
                        <span class="chevron" id="chevron-{{ loop.index0 }}">&#8250;</span>
                    </td>
                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ log.user }}</td>
                    <td>{{ log.action }}</td>
                    <td>
                        {{ log.details.split('rules:')[0] if 'rules:' in log.details else log.details }}
                        {% if not loginfo.rules_present or not loginfo.schema_present %}
                            <div class="text-warning small mt-1">
                                {% if not loginfo.rules_present %}No rules recorded in this log. {% endif %}
                                {% if not loginfo.schema_present %}No schema recorded in this log.{% endif %}
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% if loop.index0 < diffs|length %}
                {% set diff = diffs[loop.index0] %}
                <tr>
                    <td colspan="5" style="padding:0; border:none;">
                        <div class="collapse diff-collapse" id="diff-{{ loop.index0 }}">
                            {% if diff and (diff.rules_side_by_side or diff.schema_side_by_side) %}
                                {% if diff.rules_side_by_side %}
                                <div class="mb-2"><strong>Rules Side-by-Side Diff</strong></div>
                                <div class="table-responsive diff-table-wrapper" style="max-height:400px; overflow:auto;">{{ diff.rules_side_by_side | safe }}</div>
                                {% elif not logs[loop.index0].rules_present or not logs[loop.index0+1].rules_present %}
                                <div class="text-warning p-3">Rules missing for one or both logs, cannot show diff.</div>
                                {% endif %}
                                {% if diff.schema_side_by_side %}
                                <div class="mb-2"><strong>Schema Side-by-Side Diff</strong></div>
                                <div class="table-responsive diff-table-wrapper" style="max-height:400px; overflow:auto;">{{ diff.schema_side_by_side | safe }}</div>
                                {% elif not logs[loop.index0].schema_present or not logs[loop.index0+1].schema_present %}
                                <div class="text-warning p-3">Schema missing for one or both logs, cannot show diff.</div>
                                {% endif %}
                            {% else %}
                                <div class="text-muted p-3">No differences to show for this change.</div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% if not logs %}
        <p>No audit log entries found for this configuration.</p>
        {% endif %}
        <a href="{{ url_for('config.configuration') }}" class="btn btn-secondary mt-3">Back to Configurations</a>
    </div>
</div>
<style>
.diff-pre { font-family: monospace; font-size: 0.95em; }
.diff-add { background: #e6ffed !important; color: #22863a; display: block; }
.diff-del { background: #ffeef0 !important; color: #b31d28; display: block; }
.diff-ctx { color: #6a737d; display: block; }
.diff-hdr { color: #005cc5; font-weight: bold; display: block; }
.auditlog-row:hover, .auditlog-row.active { background: #f0f8ff; }
.chevron { display: inline-block; transition: transform 0.2s; font-size: 1.2em; }
.chevron.open { transform: rotate(90deg); }
.diff-table-wrapper table.diff { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.95em; }
.diff-table-wrapper .diff_header { background: #f6f8fa; font-weight: bold; }
.diff-table-wrapper .diff_next { background: #f6f8fa; }
.diff-table-wrapper .diff_add { background: #e6ffed !important; color: #22863a; }
.diff-table-wrapper .diff_chg { background: #fff5b1 !important; color: #b08800; }
.diff-table-wrapper .diff_sub { background: #ffeef0 !important; color: #b31d28; }
.diff-table-wrapper td, .diff-table-wrapper th { padding: 2px 6px; border: 1px solid #e1e4e8; }
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Highlight the selected row, handle chevron rotation, auto-scroll, and collapse logic
const rows = document.querySelectorAll('.auditlog-row');
rows.forEach((row, idx) => {
    row.addEventListener('click', function() {
        rows.forEach(r => r.classList.remove('active'));
        this.classList.add('active');
        // Chevron rotation
        document.querySelectorAll('.chevron').forEach(c => c.classList.remove('open'));
        const chev = document.getElementById('chevron-' + idx);
        if (chev) chev.classList.add('open');
        // Only toggle the selected diff-collapse
        var target = document.getElementById('diff-' + idx);
        if (target) {
            var bsCollapse = bootstrap.Collapse.getOrCreateInstance(target);
            bsCollapse.toggle();
            setTimeout(() => {
                if (target.classList.contains('show')) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 250);
        }
    });
});
</script>
{% endblock %} 