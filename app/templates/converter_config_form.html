{% extends 'base.html' %}
{% block title %}{{ action }} Converter Config{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <h3>{{ action }} Converter Config</h3>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-danger">
                    {% for message in messages %}
                        <div>{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <form method="POST" id="converterConfigForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="name" value="{{ config.name if config else '' }}" required />
            </div>
            <div class="mb-3">
                <label class="form-label">Description</label>
                <input type="text" class="form-control" name="description" value="{{ config.description if config else '' }}" />
            </div>
            <div class="mb-3">
                <label>Source Type:</label>
                <select id="sourceTypeSelect" name="source_type" data-initial="{{ config.source_type if config else '' }}"></select>
                <label>Target Type:</label>
                <select id="targetTypeSelect" name="target_type" data-initial="{{ config.target_type if config else '' }}"></select>
            </div>
            <div class="mb-3">
                <label for="rules">Mapping Rules (JSON):</label>
                <div id="jsoneditor_rules" style="height: 300px;"></div>
                <input type="hidden" id="rules" name="rules" value="{{ config.rules if config and config.rules else '{}' }}">
                <small>
                  Map target template variables to extracted source variables.<br>
                  Example:<br>
                  <pre style="background:#f8f8f8; border:1px solid #eee; padding:8px;">{
  "tag50KLine3": {"source": "Dbtr_AdrLine1"},
  "tag20": {"source": "MsgId"}
}</pre>
                </small>
            </div>
            <input type="hidden" id="schemaField" name="schema" value="{{ config.schema if config else '' }}" />
            <div class="d-grid">
                <button type="submit" class="btn btn-success">Save</button>
            </div>
        </form>
    </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', async function() {
    // Fetch file types from backend
    const resp = await fetch('/config/get_filetypes');
    const fileTypes = resp.ok ? await resp.json() : [];
    const sourceSelect = document.getElementById('sourceTypeSelect');
    const targetSelect = document.getElementById('targetTypeSelect');
    sourceSelect.innerHTML = '';
    targetSelect.innerHTML = '';
    fileTypes.forEach(ft => {
        const opt1 = document.createElement('option');
        opt1.value = ft;
        opt1.textContent = ft;
        sourceSelect.appendChild(opt1);
        const opt2 = document.createElement('option');
        opt2.value = ft;
        opt2.textContent = ft;
        targetSelect.appendChild(opt2);
    });
    // Set initial value if editing
    sourceSelect.value = sourceSelect.getAttribute('data-initial') || '';
    targetSelect.value = targetSelect.getAttribute('data-initial') || '';

    // Mapping Rules JSONEditor
    const rulesContainer = document.getElementById('jsoneditor_rules');
    const rulesEditor = new JSONEditor(rulesContainer, { mode: 'code' });
    try {
        rulesEditor.set(JSON.parse(document.getElementById('rules').value || '{}'));
    } catch { rulesEditor.set({}); }
    document.getElementById('converterConfigForm').addEventListener('submit', function(e) {
        try {
            document.getElementById('rules').value = JSON.stringify(rulesEditor.get());
        } catch {
            alert('Invalid JSON in mapping!');
            e.preventDefault();
        }
    });
});
</script>
{% endblock %} 