{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Test Execution</h2>
    <div>
      <form method="POST" action="{{ url_for('testcases.cleanup_queue') }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to clean up old queue items?')">
        <button type="submit" class="btn btn-outline-warning">üßπ Cleanup Queue</button>
      </form>
      <a href="{{ url_for('testcases.download_execution_report') }}" class="btn btn-outline-success ms-2">üìä Download Report</a>
      <a href="{{ url_for('testcases.list_testcases') }}" class="btn btn-outline-secondary ms-2">‚Üê Back to Test Cases</a>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Filters</h5>
    </div>
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Label</label>
          <select name="label" class="form-select">
            <option value="">All Labels</option>
            {% for label in labels %}
              <option value="{{ label.id }}" {% if current_filters.label == label.id %}selected{% endif %}>
                {{ label.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Test Type</label>
          <select name="test_type" class="form-select">
            <option value="">All Types</option>
            <option value="UI" {% if current_filters.test_type == 'UI' %}selected{% endif %}>UI</option>
            <option value="API" {% if current_filters.test_type == 'API' %}selected{% endif %}>API</option>
            <option value="Unit" {% if current_filters.test_type == 'Unit' %}selected{% endif %}>Unit</option>
            <option value="Integration" {% if current_filters.test_type == 'Integration' %}selected{% endif %}>Integration</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Repository</label>
          <select name="repository" class="form-select">
            <option value="">All Repositories</option>
            {% for repo in repositories %}
              <option value="{{ repo.id }}" {% if current_filters.repository == repo.id %}selected{% endif %}>
                {{ repo.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Framework</label>
          <select name="framework" class="form-select">
            <option value="">All Frameworks</option>
            {% for framework in frameworks %}
              <option value="{{ framework.id }}" {% if current_filters.framework == framework.id %}selected{% endif %}>
                {{ framework.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
          <a href="{{ url_for('testcases.execute_testcases') }}" class="btn btn-outline-secondary ms-2">Clear Filters</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Test Cases Table -->
  <form id="execute-form" method="POST">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Test Cases ({{ testcases|length }})</h5>
        <div>
          <button type="button" class="btn btn-outline-primary btn-sm" id="select-all">Select All</button>
          <button type="submit" class="btn btn-success ms-2" id="execute-btn">Execute Selected</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-checkbox"></th>
                <th>Name</th>
                <th>Repository</th>
                <th>Framework</th>
                <th>Type</th>
                <th>Labels</th>
                <th>Last Modified</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for tc in testcases %}
              <tr>
                <td><input type="checkbox" name="testcase_ids" value="{{ tc.id }}"></td>
                <td>
                  <a href="{{ url_for('testcases.testcase_detail', id=tc.id) }}">{{ tc.name }}</a>
                  {% if tc.is_discovered %}
                    <span class="badge bg-info ms-1">Auto</span>
                  {% endif %}
                </td>
                <td>
                  {% if tc.repository %}
                    <a href="{{ tc.repository.url }}" target="_blank">{{ tc.repository.name }}</a>
                    <small class="text-muted d-block">{{ tc.file_path or 'N/A' }}</small>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if tc.test_framework %}
                    <span class="badge bg-secondary">{{ tc.test_framework.name }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if tc.test_type %}
                    <span class="badge {% if tc.test_type == 'UI' %}bg-primary{% elif tc.test_type == 'API' %}bg-success{% else %}bg-warning{% endif %}">
                      {{ tc.test_type }}
                    </span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if tc.labels %}
                    {% for label in tc.labels %}
                      <span class="badge" style="background-color: {{ label.color }}">{{ label.name }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if tc.last_modified %}
                    {{ tc.last_modified.strftime('%Y-%m-%d %H:%M') }}
                  {% else %}
                    {{ tc.updated_at.strftime('%Y-%m-%d %H:%M') }}
                  {% endif %}
                </td>
                <td>
                  {% if tc.test_runs %}
                    {% set last_run = tc.test_runs[-1] %}
                    <span class="badge {% if last_run.status == 'passed' %}bg-success{% elif last_run.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">
                      {{ last_run.status|capitalize }}
                    </span>
                  {% else %}
                    <span class="badge bg-light text-dark">Never Run</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </form>

  <!-- Execution Status -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Execution Status</h5>
      <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateExecutionStatus()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    <div class="card-body">
      <div id="execution-status">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Queue Statistics -->
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">Queue Statistics</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body text-center">
              <h3 id="pending-count">-</h3>
              <p class="mb-0">Pending</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h3 id="running-count">-</h3>
              <p class="mb-0">Running</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h3 id="completed-count">-</h3>
              <p class="mb-0">Completed</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-danger text-white">
            <div class="card-body text-center">
              <h3 id="failed-count">-</h3>
              <p class="mb-0">Failed</p>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <small class="text-muted">Last updated: <span id="last-update">-</span></small>
      </div>
    </div>
  </div>

  <!-- CI/CD Monitoring Dashboard -->
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">System Monitor (CI/CD Style)</h5>
      <button type="button" class="btn btn-sm btn-outline-info" onclick="updateSystemMonitor()">
        <i class="fas fa-chart-line"></i> Refresh
      </button>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- System Resources -->
        <div class="col-md-6">
          <h6>System Resources</h6>
          <div id="system-resources">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Queue Statistics -->
        <div class="col-md-6">
          <h6>Queue Statistics</h6>
          <div id="queue-stats">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Active Processes -->
      <div class="mt-3">
        <h6>Active Processes</h6>
        <div id="active-processes">
          <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Execution Logs Modal -->
<div class="modal fade" id="executionLogsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Execution Logs</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="execution-logs-content">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Select all functionality
document.getElementById('select-all-checkbox').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('input[name="testcase_ids"]');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

document.getElementById('select-all').addEventListener('click', function() {
  const checkboxes = document.querySelectorAll('input[name="testcase_ids"]');
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  checkboxes.forEach(cb => cb.checked = !allChecked);
  document.getElementById('select-all-checkbox').checked = !allChecked;
});

// Real-time status updates
function updateExecutionStatus() {
  fetch('{{ url_for("testcases.execution_status") }}')
    .then(response => response.json())
    .then(data => {
      const statusDiv = document.getElementById('execution-status');
      if (data.length === 0) {
        statusDiv.innerHTML = '<div class="text-center text-muted"><p>No executions in progress...</p></div>';
        return;
      }
      
      let html = '<div class="table-responsive"><table class="table table-sm">';
      html += '<thead><tr><th>Test Case</th><th>Status</th><th>Queued</th><th>Started</th><th>Completed</th><th>Result</th></tr></thead><tbody>';
      
      data.forEach(item => {
        const statusClass = item.status === 'completed' ? 'success' : 
                           item.status === 'running' ? 'warning' : 
                           item.status === 'failed' ? 'danger' : 'secondary';
        
        html += `<tr>
          <td><a href="#" class="execution-log-link" data-queue-id="${item.id}">${item.test_case_name}</a></td>
          <td><span class="badge bg-${statusClass}">${item.status}</span></td>
          <td>${item.queued_at || '-'}</td>
          <td>${item.started_at || '-'}</td>
          <td>${item.completed_at || '-'}</td>
          <td>${item.result || '-'}</td>
        </tr>`;
      });
      
      html += '</tbody></table></div>';
      statusDiv.innerHTML = html;
      
      // Add click handlers for execution log links
      document.querySelectorAll('.execution-log-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const queueId = this.getAttribute('data-queue-id');
          showExecutionLogs(queueId);
        });
      });
    })
    .catch(error => {
      console.error('Error fetching execution status:', error);
    });
}

// Auto-refresh every 5 seconds
setInterval(updateExecutionStatus, 5000);

// Update system monitor
function updateSystemMonitor() {
  fetch('{{ url_for("testcases.execution_monitor") }}')
    .then(response => response.json())
    .then(data => {
      // Update system resources
      const resources = data.system_resources;
      const resourcesHtml = `
        <div class="row">
          <div class="col-6">
            <div class="d-flex justify-content-between">
              <span>CPU Usage:</span>
              <span class="badge bg-${resources.cpu_percent > 80 ? 'danger' : resources.cpu_percent > 60 ? 'warning' : 'success'}">${resources.cpu_percent.toFixed(1)}%</span>
            </div>
            <div class="progress mt-1" style="height: 6px;">
              <div class="progress-bar bg-${resources.cpu_percent > 80 ? 'danger' : resources.cpu_percent > 60 ? 'warning' : 'success'}" style="width: ${resources.cpu_percent}%"></div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex justify-content-between">
              <span>Memory Usage:</span>
              <span class="badge bg-${resources.memory_percent > 80 ? 'danger' : resources.memory_percent > 60 ? 'warning' : 'success'}">${resources.memory_percent.toFixed(1)}%</span>
            </div>
            <div class="progress mt-1" style="height: 6px;">
              <div class="progress-bar bg-${resources.memory_percent > 80 ? 'danger' : resources.memory_percent > 60 ? 'warning' : 'success'}" style="width: ${resources.memory_percent}%"></div>
            </div>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-6">
            <small class="text-muted">Available Memory: ${resources.memory_available_gb.toFixed(1)} GB</small>
          </div>
          <div class="col-6">
            <small class="text-muted">Disk Free: ${resources.disk_free_gb.toFixed(1)} GB</small>
          </div>
        </div>
      `;
      document.getElementById('system-resources').innerHTML = resourcesHtml;
      
      // Update queue statistics
      const stats = data.queue_stats;
      const statsHtml = `
        <div class="row">
          <div class="col-3 text-center">
            <div class="border rounded p-2">
              <div class="h5 mb-0 text-primary">${stats.pending}</div>
              <small class="text-muted">Pending</small>
            </div>
          </div>
          <div class="col-3 text-center">
            <div class="border rounded p-2">
              <div class="h5 mb-0 text-warning">${stats.running}</div>
              <small class="text-muted">Running</small>
            </div>
          </div>
          <div class="col-3 text-center">
            <div class="border rounded p-2">
              <div class="h5 mb-0 text-success">${stats.completed}</div>
              <small class="text-muted">Completed</small>
            </div>
          </div>
          <div class="col-3 text-center">
            <div class="border rounded p-2">
              <div class="h5 mb-0 text-danger">${stats.failed}</div>
              <small class="text-muted">Failed</small>
            </div>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">Total: ${stats.total} tests</small>
        </div>
      `;
      document.getElementById('queue-stats').innerHTML = statsHtml;
      
      // Update active processes
      const processes = data.active_processes;
      if (Object.keys(processes).length === 0) {
        document.getElementById('active-processes').innerHTML = '<p class="text-muted text-center">No active processes</p>';
      } else {
        let processesHtml = '<div class="table-responsive"><table class="table table-sm">';
        processesHtml += '<thead><tr><th>Queue ID</th><th>PID</th><th>Command</th><th>Started</th></tr></thead><tbody>';
        
        for (const [queueId, process] of Object.entries(processes)) {
          const startTime = new Date(process.start_time).toLocaleTimeString();
          processesHtml += `
            <tr>
              <td><a href="#" class="execution-log-link" data-queue-id="${queueId}">${queueId}</a></td>
              <td><code>${process.pid}</code></td>
              <td><small class="text-muted">${process.command.substring(0, 50)}${process.command.length > 50 ? '...' : ''}</small></td>
              <td><small>${startTime}</small></td>
            </tr>
          `;
        }
        
        processesHtml += '</tbody></table></div>';
        document.getElementById('active-processes').innerHTML = processesHtml;
        
        // Add click handlers for execution log links
        document.querySelectorAll('.execution-log-link').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const queueId = this.getAttribute('data-queue-id');
            showExecutionLogs(queueId);
          });
        });
      }
    })
    .catch(error => {
      console.error('Error fetching system monitor data:', error);
      document.getElementById('system-resources').innerHTML = '<div class="alert alert-danger">Error loading system resources</div>';
      document.getElementById('queue-stats').innerHTML = '<div class="alert alert-danger">Error loading queue statistics</div>';
      document.getElementById('active-processes').innerHTML = '<div class="alert alert-danger">Error loading active processes</div>';
    });
}

// Auto-refresh system monitor every 10 seconds
setInterval(updateSystemMonitor, 10000);

// Update queue statistics
function updateQueueStatistics() {
  fetch('{{ url_for("testcases.execution_monitor") }}')
    .then(response => response.json())
    .then(data => {
      const stats = data.queue_stats;
      document.getElementById('pending-count').textContent = stats.pending;
      document.getElementById('running-count').textContent = stats.running;
      document.getElementById('completed-count').textContent = stats.completed;
      document.getElementById('failed-count').textContent = stats.failed;
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    })
    .catch(error => {
      console.error('Error fetching queue statistics:', error);
    });
}

// Auto-refresh queue statistics every 5 seconds
setInterval(updateQueueStatistics, 5000);

// Show execution logs
function showExecutionLogs(queueId) {
  const modal = new bootstrap.Modal(document.getElementById('executionLogsModal'));
  const contentDiv = document.getElementById('execution-logs-content');
  
  // Show loading spinner
  contentDiv.innerHTML = `
    <div class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  `;
  
  modal.show();
  
  // Fetch execution logs
  fetch(`{{ url_for('testcases.execution_logs', queue_id=0) }}`.replace('0', queueId))
    .then(response => response.json())
    .then(data => {
      let html = `
        <div class="mb-3">
          <h6>Test Case: ${data.test_case_name}</h6>
          <p class="text-muted mb-0">Status: <span class="badge bg-${data.status === 'completed' ? 'success' : data.status === 'running' ? 'warning' : data.status === 'failed' ? 'danger' : 'secondary'}">${data.status}</span></p>
          <p class="text-muted mb-0">Queued: ${data.queued_at || 'N/A'}</p>
        </div>
      `;
      
      if (data.execution_details) {
        const details = data.execution_details;
        
        if (details.command) {
          html += `
            <div class="mb-3">
              <h6>Command Executed:</h6>
              <code class="d-block p-2 bg-light">${details.command}</code>
            </div>
          `;
        }
        
        if (details.logs) {
          html += `
            <div class="mb-3">
              <h6>Execution Logs:</h6>
              <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">${details.logs}</pre>
            </div>
          `;
        }
        
        if (details.output) {
          html += `
            <div class="mb-3">
              <h6>Output:</h6>
              <pre class="bg-light p-3" style="max-height: 200px; overflow-y: auto;">${details.output}</pre>
            </div>
          `;
        }
        
        if (details.error) {
          html += `
            <div class="mb-3">
              <h6>Error:</h6>
              <pre class="bg-danger text-light p-3" style="max-height: 200px; overflow-y: auto;">${details.error}</pre>
            </div>
          `;
        }
        
        if (details.duration) {
          html += `
            <div class="mb-3">
              <h6>Duration:</h6>
              <p>${details.duration.toFixed(2)} seconds</p>
            </div>
          `;
        }
      } else {
        html += '<p class="text-muted">No execution details available.</p>';
      }
      
      contentDiv.innerHTML = html;
    })
    .catch(error => {
      contentDiv.innerHTML = `
        <div class="alert alert-danger">
          Error loading execution logs: ${error.message}
        </div>
      `;
    });
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
  updateExecutionStatus();
  updateSystemMonitor();
  updateQueueStatistics();
});
</script>
{% endblock %} 