{% extends 'base.html' %}
{% block title %}{{ action }} Configuration{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>
<div class="card">
    <div class="card-body">
        <h3>{{ action }} Configuration</h3>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-danger">
                    {% for message in messages %}
                        <div>{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        {% if form.errors %}
            <div class="alert alert-danger">
                <ul class="mb-0">
                {% for field, errors in form.errors.items() %}
                    {% for error in errors %}
                        <li><strong>{{ field|capitalize }}:</strong> {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                </ul>
            </div>
        {% endif %}
        <form method="POST" id="configForm">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.name.label(class="form-label") }}
                {{ form.name(class="form-control") }}
                {% if form.name.errors %}
                    <div class="text-danger small">{{ form.name.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                {{ form.description.label(class="form-label") }}
                {{ form.description(class="form-control") }}
                {% if form.description.errors %}
                    <div class="text-danger small">{{ form.description.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                {{ form.file_type.label(class="form-label") }}
                {{ form.file_type(class="form-select") }}
                {% if not form.file_type.choices %}
                    <div class="text-danger small">No file types available. Please add file types first.</div>
                {% endif %}
                {% if form.file_type.errors %}
                    <div class="text-danger small">{{ form.file_type.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label class="form-label">Rules (JSON)</label>
                <div class="d-flex mb-2">
                    <button type="button" class="btn btn-secondary btn-sm me-2" id="importRulesBtn">Import</button>
                    <button type="button" class="btn btn-secondary btn-sm me-2" id="exportRulesBtn">Export</button>
                </div>
                <div id="jsoneditor" style="height: 300px;"></div>
                {{ form.rules(class="form-control d-none", id="rulesField") }}
                <small class="form-text text-muted">Example: <code>{"field1": "value", "field2": 123}</code></small>
                {% if form.rules.errors %}
                    <div class="text-danger small">{{ form.rules.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label class="form-label">Schema Type</label>
                <select id="schemaType" class="form-select" name="schema_type">
                    <option value="json" selected>JSON Schema</option>
                    <option value="xml">XML Schema (XSD)</option>
                    <option value="text">Text</option>
                </select>
            </div>
            <div id="jsonSchemaSection">
                <div class="mb-2 d-flex">
                    <select id="schemaTemplate" class="form-select form-select-sm me-2" style="width:auto;">
                        <option value="">Insert Schema Template...</option>
                        <option value="object">Flat Object</option>
                        <option value="array">Array of Objects</option>
                        <option value="string">String Only</option>
                    </select>
                    <button type="button" class="btn btn-secondary btn-sm me-2" id="importSchemaBtn">Import</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="exportSchemaBtn">Export</button>
                </div>
                <div id="schemaeditor" style="height: 300px;"></div>
                {{ form.schema(class="form-control d-none", id="schemaField") }}
                <small class="form-text text-muted">Example: <code>{"type": "object", "properties": {"field1": {"type": "string"}, "field2": {"type": "number"}}, "required": ["field1", "field2"]}</code></small>
                {% if form.schema.errors %}
                    <div class="text-danger small">{{ form.schema.errors[0] }}</div>
                {% endif %}
            </div>
            <div id="xmlSchemaSection" style="display:none;">
                <label class="form-label">XML Schema (XSD)</label>
                <textarea class="form-control" id="xsdField" name="xsd" rows="8"></textarea>
                <small class="form-text text-muted">Paste your XSD here.</small>
            </div>
            <div id="textSchemaSection" style="display:none;">
                <label class="form-label">Text Rules/Schema</label>
                <textarea class="form-control" id="textSchemaField" name="text_schema" rows="8"></textarea>
                <small class="form-text text-muted">Paste your plain text rules or schema here.</small>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-info" id="previewBtn">Preview/Test Rules & Schema</button>
            </div>
            <div class="mb-3">
                <div id="previewResult"></div>
            </div>
            <div class="d-grid">
                {{ form.submit(class="btn btn-success") }}
            </div>
        </form>
    </div>
</div>
<script>
    // JSONEditor for rules
    var container = document.getElementById('jsoneditor');
    var textarea = document.getElementById('rulesField');
    var options = { mode: 'code', modes: ['code', 'tree'] };
    var editor = new JSONEditor(container, options);
    if (textarea.value) {
        try {
            editor.set(JSON.parse(textarea.value));
        } catch (e) {
            editor.set({});
        }
    }
    // JSONEditor for schema
    var schemaContainer = document.getElementById('schemaeditor');
    var schemaTextarea = document.getElementById('schemaField');
    var schemaEditor = new JSONEditor(schemaContainer, options);
    if (schemaTextarea.value) {
        try {
            schemaEditor.set(JSON.parse(schemaTextarea.value));
        } catch (e) {
            schemaEditor.set({});
        }
    }
    // Schema templates
    var templates = {
        object: {"type": "object", "properties": {"field1": {"type": "string"}, "field2": {"type": "number"}}, "required": ["field1", "field2"]},
        array: {"type": "array", "items": {"type": "object", "properties": {"name": {"type": "string"}, "value": {"type": "number"}}}},
        string: {"type": "string"}
    };
    document.getElementById('schemaTemplate').onchange = function() {
        var val = this.value;
        if (templates[val]) {
            schemaEditor.set(templates[val]);
        }
        this.value = '';
    };
    // Import/Export for rules
    document.getElementById('importRulesBtn').onclick = function() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = function(e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    editor.set(JSON.parse(evt.target.result));
                } catch (e) {
                    alert('Invalid JSON file!');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    };
    document.getElementById('exportRulesBtn').onclick = function() {
        var data = JSON.stringify(editor.get(), null, 2);
        var blob = new Blob([data], {type: 'application/json'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'rules.json';
        a.click();
        URL.revokeObjectURL(url);
    };
    // Import/Export for schema
    document.getElementById('importSchemaBtn').onclick = function() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = function(e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    schemaEditor.set(JSON.parse(evt.target.result));
                } catch (e) {
                    alert('Invalid JSON file!');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    };
    document.getElementById('exportSchemaBtn').onclick = function() {
        var data = JSON.stringify(schemaEditor.get(), null, 2);
        var blob = new Blob([data], {type: 'application/json'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'schema.json';
        a.click();
        URL.revokeObjectURL(url);
    };
    // Toggle JSON/XML schema
    var schemaType = document.getElementById('schemaType');
    var jsonSchemaSection = document.getElementById('jsonSchemaSection');
    var xmlSchemaSection = document.getElementById('xmlSchemaSection');
    var textSchemaSection = document.getElementById('textSchemaSection');
    schemaType.onchange = function() {
        if (this.value === 'json') {
            jsonSchemaSection.style.display = '';
            xmlSchemaSection.style.display = 'none';
            textSchemaSection.style.display = 'none';
        } else if (this.value === 'xml') {
            jsonSchemaSection.style.display = 'none';
            xmlSchemaSection.style.display = '';
            textSchemaSection.style.display = 'none';
        } else {
            jsonSchemaSection.style.display = 'none';
            xmlSchemaSection.style.display = 'none';
            textSchemaSection.style.display = '';
        }
    };
    // On form submit, update both textareas with JSON string
    document.getElementById('configForm').onsubmit = function() {
        if (schemaType.value === 'json') {
            try {
                textarea.value = JSON.stringify(editor.get());
            } catch (e) {
                alert('Invalid JSON in rules!');
                return false;
            }
            if (schemaEditor.get()) {
                try {
                    schemaTextarea.value = JSON.stringify(schemaEditor.get());
                } catch (e) {
                    alert('Invalid JSON in schema!');
                    return false;
                }
            } else {
                schemaTextarea.value = '';
            }
        } else if (schemaType.value === 'xml') {
            // For XML, clear JSON fields
            textarea.value = '';
            schemaTextarea.value = '';
        } else {
            // For Text, clear JSON/XML fields
            textarea.value = '';
            schemaTextarea.value = '';
        }
    };
    // Preview/Test button logic
    document.getElementById('previewBtn').onclick = function() {
        var previewResult = document.getElementById('previewResult');
        previewResult.innerHTML = '';
        if (schemaType.value === 'json') {
            var rules, schema;
            try {
                rules = editor.get();
            } catch (e) {
                previewResult.innerHTML = '<div class="alert alert-danger">Invalid JSON in rules: ' + e.message + '</div>';
                return;
            }
            try {
                schema = schemaEditor.get();
            } catch (e) {
                previewResult.innerHTML = '<div class="alert alert-danger">Invalid JSON in schema: ' + e.message + '</div>';
                return;
            }
            if (Object.keys(schema).length === 0) {
                previewResult.innerHTML = '<div class="alert alert-info">No schema provided. Rules JSON is valid.</div>';
                return;
            }
            // Validate rules against schema using ajv (client-side)
            fetch('https://cdn.jsdelivr.net/npm/ajv@8.12.0/dist/ajv7.min.js')
                .then(response => response.text())
                .then(js => {
                    eval(js); // Load Ajv
                    var ajv = new Ajv();
                    var valid = false;
                    var errorMsg = '';
                    try {
                        valid = ajv.validate(schema, rules);
                        if (!valid) {
                            errorMsg = ajv.errorsText(ajv.errors);
                        }
                    } catch (e) {
                        errorMsg = e.message;
                    }
                    if (valid) {
                        previewResult.innerHTML = '<div class="alert alert-success">Rules match the schema!</div>';
                    } else {
                        previewResult.innerHTML = '<div class="alert alert-danger">Rules do not match the schema: ' + errorMsg + '</div>';
                    }
                });
        } else {
            // XML schema validation (client-side, basic check)
            var xsd = document.getElementById('xsdField').value;
            if (!xsd.trim()) {
                previewResult.innerHTML = '<div class="alert alert-info">No XSD provided.</div>';
                return;
            }
            // Basic well-formedness check
            try {
                var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(xsd, "application/xml");
                var parseError = xmlDoc.getElementsByTagName("parsererror");
                if (parseError.length > 0) {
                    previewResult.innerHTML = '<div class="alert alert-danger">Invalid XSD: ' + parseError[0].textContent + '</div>';
                } else {
                    previewResult.innerHTML = '<div class="alert alert-success">XSD appears well-formed.</div>';
                }
            } catch (e) {
                previewResult.innerHTML = '<div class="alert alert-danger">Invalid XSD: ' + e.message + '</div>';
            }
        }
    };
</script>
{% endblock %} 